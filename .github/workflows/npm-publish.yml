name: Deploy React App to S3

on:
  push:
    branches:
      - main  # main 브랜치에 푸시될 때 트리거

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.18.2'  # 지정한 Node.js 버전

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies
        run: yarn install

      - name: Build React app
        run: yarn build

      - name: Zip build artifacts
        run: zip -r build.zip build/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.S3_REGION }}

      - name: Upload zip to backup folder using commit id
        run: |
          # 현재 커밋의 SHA 값을 사용하여 zip 파일 업로드
          aws s3 cp build.zip s3://${{ secrets.S3_BUCKET }}/backups/${{ github.sha }}-build.zip

      - name: Remove existing static files (except backups)
        run: |
          # backup 폴더를 제외한 모든 파일과 폴더를 삭제
          aws s3 ls s3://${{ secrets.S3_BUCKET }}/ | while read -r line;
          do
            folder=$(echo $line | awk '{print $2}');
            if [[ "$folder" != "backups/" ]]; then
              aws s3 rm s3://${{ secrets.S3_BUCKET }}/$folder --recursive;
            fi
          done

      - name: Upload new build files
        run: |
          # 새로운 빌드 파일 업로드
          aws s3 cp --recursive build/ s3://${{ secrets.S3_BUCKET }}/
